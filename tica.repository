[1mdiff --git a/recording.jfr b/recording.jfr[m
[1mindex 692edc8..8c51188 100644[m
Binary files a/recording.jfr and b/recording.jfr differ
[1mdiff --git a/src/main/java/br/com/wta/frete/BrFreteApplication.java b/src/main/java/br/com/wta/frete/BrFreteApplication.java[m
[1mindex e6a8350..00d87cc 100644[m
[1m--- a/src/main/java/br/com/wta/frete/BrFreteApplication.java[m
[1m+++ b/src/main/java/br/com/wta/frete/BrFreteApplication.java[m
[36m@@ -2,8 +2,10 @@[m [mpackage br.com.wta.frete;[m
 [m
 import org.springframework.boot.SpringApplication;[m
 import org.springframework.boot.autoconfigure.SpringBootApplication;[m
[32m+[m[32mimport org.springframework.scheduling.annotation.EnableScheduling;[m
 [m
 @SpringBootApplication[m
[32m+[m[32m@EnableScheduling[m
 public class BrFreteApplication {[m
 [m
 	public static void main(String[] args) {[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/controller/dto/FreteResponse.java b/src/main/java/br/com/wta/frete/logistica/controller/dto/FreteResponse.java[m
[1mindex 4ee122d..c07a8f3 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/controller/dto/FreteResponse.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/controller/dto/FreteResponse.java[m
[36m@@ -1,49 +1,41 @@[m
 package br.com.wta.frete.logistica.controller.dto;[m
 [m
 import java.math.BigDecimal;[m
[31m-import java.time.LocalDateTime; // Importado para compatibilidade com a Entidade Frete[m
[31m-import java.time.ZonedDateTime;[m
[32m+[m[32mimport java.time.LocalDateTime;[m
 [m
 /**[m
[31m- * DTO de Resposta para a entidade Frete (logistica.fretes). Retorna os detalhes[m
[31m- * do processo de leil√£o/proposta de um frete.[m
[32m+[m[32m * DTO de Resposta para a entidade Frete.[m
  */[m
 public record FreteResponse([m
[31m-		// FK para a Ordem de Servi√ßo (Chave Prim√°ria e Estrangeira)[m
[32m+[m		[32m// [NOVO] ID Pr√≥prio do Frete[m
[32m+[m		[32mLong freteId,[m
[32m+[m
[32m+[m		[32m// Campos herdados da OrdemServico (para refer√™ncia)[m
 		Long ordemServicoId,[m
 [m
[31m-		// FK para a Modalidade de Frete (Lookup)[m
[32m+[m		[32m// Campos de Relacionamento[m
 		Integer modalidadeId,[m
[31m-[m
[31m-		// FK para o Status do Leil√£o (Lookup)[m
[32m+[m		[32mString nomeModalidade,[m
 		Integer statusLeilaoId,[m
[32m+[m		[32mString nomeStatusLeilao,[m
 [m
[31m-		// Data e hora limite para receber propostas (TIMESTAMP WITH TIME ZONE)[m
[31m-		ZonedDateTime prazoEncerramento,[m
[31m-[m
[31m-		// Valor base sugerido para o frete (NUMERIC)[m
[31m-		BigDecimal valorInicialProposto,[m
[31m-[m
[31m-		// Valor final aceito, se o leil√£o foi fechado (NUMERIC)[m
[31m-		BigDecimal valorFinalAceito,[m
[31m-[m
[31m-		// Tipo de embalagem requerida/utilizada[m
[31m-		String tipoEmbalagem,[m
[31m-[m
[31m-		// --- NOVOS CAMPOS ADICIONADOS (Para resolver os Warnings) ---[m
[31m-[m
[31m-		// Dist√¢ncia rodovi√°ria em Km (NUMERIC)[m
[31m-		BigDecimal distanciaKm,[m
[31m-[m
[31m-		// Piso m√≠nimo de frete sugerido pela ANTT (NUMERIC)[m
[31m-		BigDecimal anttPisoMinimo,[m
[32m+[m		[32m// [NOVO] Transportador Selecionado (Pode ser null)[m
[32m+[m		[32mLong transportadorSelecionadoId,[m
 [m
[31m-		// Pre√ßo sugerido de mercado para o frete (NUMERIC)[m
[32m+[m		[32m// Campos de Negocia√ß√£o[m
[32m+[m		[32mLocalDateTime dataExpiracaoNegociacao,[m
 		BigDecimal precoSugerido,[m
[31m-[m
[31m-		// Custo base de mercado calculado (NUMERIC)[m
[32m+[m		[32mBigDecimal anttPisoMinimo,[m
 		BigDecimal custoBaseMercado,[m
[32m+[m		[32mBigDecimal distanciaKm,[m
[32m+[m		[32mBigDecimal valorFinalAceito,[m
[32m+[m
[32m+[m		[32m// Campos de Log√≠stica Adicionais[m
[32m+[m		[32mBigDecimal pesoTotalKg,[m
[32m+[m		[32mBigDecimal valorInicialProposto,[m
[32m+[m		[32mString tipoEmbalagem[m
 [m
[31m-		// Data e hora de expira√ß√£o da negocia√ß√£o[m
[31m-		LocalDateTime dataExpiracaoNegociacao) { // Usando LocalDateTime conforme a Entidade[m
[32m+[m[32m// O campo 'prazoEncerramento' deve ser removido do DTO se existia antes,[m
[32m+[m[32m// sendo substitu√≠do por 'dataExpiracaoNegociacao'[m
[32m+[m[32m) {[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteRequest.java b/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteRequest.java[m
[1mindex c958db5..35ef96b 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteRequest.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteRequest.java[m
[36m@@ -9,23 +9,28 @@[m [mimport jakarta.validation.constraints.Size;[m
 [m
 /**[m
  * DTO de Requisi√ß√£o para receber dados de um ItemFrete (logistica.itens_frete).[m
[32m+[m[32m * * CORRE√á√ïES: Nomes dos campos alinhados ao novo padr√£o.[m
  */[m
 public record ItemFreteRequest([m
[31m-		// FK para a OrdemServico. Marcado como NOT NULL, pois √© essencial para a[m
[31m-		// persist√™ncia.[m
[31m-		@NotNull(message = "O ID da Ordem de Servi√ßo (Frete) √© obrigat√≥rio") Long ordemServicoId,[m
[32m+[m		[32m// FK para o Frete. Renomeado para 'freteId'[m
[32m+[m		[32m@NotNull(message = "O ID do Frete √© obrigat√≥rio") Long freteId,[m
 [m
[31m-		@NotBlank(message = "A descri√ß√£o do item √© obrigat√≥ria") @Size(max = 255) String descricaoItem,[m
[32m+[m		[32m// NOME CORRIGIDO: 'descricaoItem' para 'descricao'[m
[32m+[m		[32m// Removemos @Size pois o tipo SQL √© TEXT.[m
[32m+[m		[32m@NotBlank(message = "A descri√ß√£o do item √© obrigat√≥ria") String descricao,[m
 [m
[31m-		@NotNull(message = "O peso √© obrigat√≥rio") @DecimalMin(value = "0.01", message = "O peso deve ser positivo") BigDecimal quantidadePesoKg,[m
[32m+[m		[32m// NOVO CAMPO: Adicionamos o 'tipoMaterial'[m
[32m+[m		[32m@Size(max = 100) String tipoMaterial,[m
 [m
[31m-		@DecimalMin(value = "0.0", message = "O volume n√£o pode ser negativo") BigDecimal volumeM3,[m
[32m+[m		[32m// NOME CORRIGIDO: 'quantidadePesoKg' para 'pesoEstimadoKg'[m
[32m+[m		[32m@NotNull(message = "O peso √© obrigat√≥rio") @DecimalMin(value = "0.01", message = "O peso deve ser positivo") BigDecimal pesoEstimadoKg,[m
 [m
[31m-		@DecimalMin(value = "0.0", message = "O valor estimado n√£o pode ser negativo") BigDecimal valorEstimadoUnitario) {[m
[32m+[m		[32m// NOME CORRIGIDO: 'volumeM3' para 'volumeEstimadoM3'[m
[32m+[m		[32m@DecimalMin(value = "0.0", message = "O volume n√£o pode ser negativo") BigDecimal volumeEstimadoM3) {[m
 [m
[31m-	// CORRE√á√ÉO: M√©todo adicionado para resolver o erro 'pesoEstimadoKg' no[m
[31m-	// FreteService.[m
[31m-	public BigDecimal pesoEstimadoKg() {[m
[31m-		return quantidadePesoKg;[m
[31m-	}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * M√âTODO REMOVIDO: O m√©todo 'pesoEstimadoKg()' que estava aqui foi removido,[m
[32m+[m	[32m * pois agora o nome do campo j√° √© 'pesoEstimadoKg', eliminando a necessidade[m
[32m+[m	[32m * de getters customizados.[m
[32m+[m	[32m */[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteResponse.java b/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteResponse.java[m
[1mindex 6a89230..02b74ac 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteResponse.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteResponse.java[m
[36m@@ -1,27 +1,31 @@[m
[32m+[m[32m// Caminho: src/main/java/br/com/wta/frete/logistica/controller/dto/ItemFreteResponse.java[m
 package br.com.wta.frete.logistica.controller.dto;[m
 [m
 import java.math.BigDecimal;[m
 [m
 /**[m
[31m- * DTO de Resposta para a entidade ItemFrete (logistica.itens_frete). Retorna os[m
[31m- * detalhes de um item espec√≠fico que faz parte de uma Ordem de Servi√ßo.[m
[32m+[m[32m * DTO de Resposta para a entidade ItemFrete.[m
[32m+[m[32m * * CORRE√á√ïES: Alinhamento de nomes de campos com a Entidade.[m
  */[m
 public record ItemFreteResponse([m
[31m-		// Chave prim√°ria do item de frete (renomeado de 'id' para clareza)[m
[32m+[m		[32m// ID do item (chave prim√°ria de ItemFrete)[m
 		Long itemFreteId,[m
 [m
[31m-		// FK para a Ordem de Servi√ßo a que este item pertence[m
[31m-		Long ordemServicoId,[m
[32m+[m		[32m// Chave Externa para o Frete[m
[32m+[m		[32mLong freteId,[m
 [m
[31m-		// Descri√ß√£o do material ou produto[m
[31m-		String descricaoItem,[m
[32m+[m		[32m// NOME CORRIGIDO: 'nomeItem' para 'descricao'[m
[32m+[m		[32mString descricao,[m
 [m
[31m-		// Quantidade em peso (KG) do item[m
[31m-		BigDecimal quantidadePesoKg,[m
[32m+[m		[32m// NOVO CAMPO: 'tipoMaterial'[m
[32m+[m		[32mString tipoMaterial,[m
 [m
[31m-		// Volume em metros c√∫bicos (M3) do item[m
[31m-		BigDecimal volumeM3,[m
[32m+[m		[32m// Peso Estimado[m
[32m+[m		[32mBigDecimal pesoEstimadoKg) {[m
 [m
[31m-		// Valor unit√°rio estimado do item[m
[31m-		BigDecimal valorEstimadoUnitario) {[m
[32m+[m	[32m/**[m
[32m+[m	[32m * CAMPO REMOVIDO: 'observacao' n√£o existia no SQL nem na Entidade.[m
[32m+[m	[32m * O volume ('volumeEstimadoM3') tamb√©m n√£o foi inclu√≠do aqui para manter o DTO[m
[32m+[m	[32m * de resposta mais limpo, focando nos campos essenciais.[m
[32m+[m	[32m */[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceRequest.java b/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceRequest.java[m
[1mindex 856b4b8..5243aa4 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceRequest.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceRequest.java[m
[36m@@ -1,21 +1,17 @@[m
 package br.com.wta.frete.logistica.controller.dto;[m
 [m
 import java.math.BigDecimal;[m
[31m-import jakarta.validation.constraints.NotNull;[m
[32m+[m
 import jakarta.validation.constraints.DecimalMin;[m
[32m+[m[32mimport jakarta.validation.constraints.NotNull;[m
 [m
 /**[m
[31m- * DTO de Requisi√ß√£o para registrar uma proposta de Lance de frete[m
[31m- * (logistica.lances).[m
[32m+[m[32m * DTO de requisi√ß√£o para submeter um novo lance ou atualizar um lance[m
[32m+[m[32m * existente.[m
[32m+[m[32m * CORRE√á√ÉO: 'valorProposto' renomeado para 'valorLance'.[m
  */[m
 public record LanceRequest([m
[31m-		// ID do Frete (ID da Ordem de Servi√ßo)[m
[31m-		@NotNull(message = "O ID da Ordem de Servi√ßo (Frete) √© obrigat√≥rio") Long ordemServicoId,[m
[31m-[m
[31m-		// ID do Transportador que est√° fazendo o lance[m
[31m-		@NotNull(message = "O ID do Transportador √© obrigat√≥rio") Long transportadorPessoaId,[m
[32m+[m		[32m@NotNull(message = "O ID do Transportador √© obrigat√≥rio.") Long transportadorId,[m
 [m
[31m-		@NotNull(message = "O valor proposto √© obrigat√≥rio")[m
[31m-		// O valor deve ser maior que zero (inclusive = false)[m
[31m-		@DecimalMin(value = "0.0", inclusive = false, message = "O valor deve ser positivo") BigDecimal valorProposto) {[m
[32m+[m		[32m@NotNull(message = "O valor do lance √© obrigat√≥rio.") @DecimalMin(value = "0.01", message = "O valor deve ser positivo.") BigDecimal valorLance) {[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceResponse.java b/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceResponse.java[m
[1mindex f0fd973..f03dcc0 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceResponse.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/controller/dto/LanceResponse.java[m
[36m@@ -1,28 +1,20 @@[m
 package br.com.wta.frete.logistica.controller.dto;[m
 [m
[31m-import java.time.ZonedDateTime;[m
 import java.math.BigDecimal;[m
[32m+[m[32mimport java.time.LocalDateTime;[m
 [m
 /**[m
[31m- * DTO de Resposta para a entidade Lance (logistica.lances). Retorna os detalhes[m
[31m- * da proposta de valor de um transportador para um frete.[m
[32m+[m[32m * DTO de resposta para um Lance.[m
[32m+[m[32m * CORRE√á√ÉO: 'valorProposto' renomeado para 'valorLance'. Adicionado[m
[32m+[m[32m * 'motivoCancelamento'.[m
  */[m
 public record LanceResponse([m
[31m-		// Chave prim√°ria do Lance (renomeado de 'id' para clareza)[m
 		Long lanceId,[m
[31m-[m
[31m-		// FK para a Ordem de Servi√ßo (Frete) a que o lance se refere[m
[31m-		Long ordemServicoId,[m
[31m-[m
[31m-		// FK para o Transportador que fez a proposta[m
[31m-		Long transportadorPessoaId,[m
[31m-[m
[31m-		// O valor proposto (NUMERIC)[m
[31m-		BigDecimal valorProposto,[m
[31m-[m
[31m-		// Data e hora em que o lance foi registrado (TIMESTAMP WITH TIME ZONE)[m
[31m-		ZonedDateTime dataLance,[m
[31m-[m
[31m-		// Indica se este lance foi o vencedor (BOOLEAN)[m
[31m-		Boolean vencedor) {[m
[32m+[m		[32mLong freteId, // Corresponde a frete.freteId[m
[32m+[m		[32mLong transportadorId,[m
[32m+[m		[32mString nomeTransportador,[m
[32m+[m		[32mBigDecimal valorLance,[m
[32m+[m		[32mLocalDateTime dataLance,[m
[32m+[m		[32mboolean vencedor,[m
[32m+[m		[32mString motivoCancelamento) {[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/entity/Frete.java b/src/main/java/br/com/wta/frete/logistica/entity/Frete.java[m
[1mindex 79c0690..03ea2ae 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/entity/Frete.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/entity/Frete.java[m
[36m@@ -1,101 +1,88 @@[m
 package br.com.wta.frete.logistica.entity;[m
 [m
 import java.math.BigDecimal;[m
[31m-import java.time.LocalDateTime; // Alterado para LocalDateTime para compatibilidade com FreteService[m
[31m-import java.time.ZonedDateTime;[m
[32m+[m[32mimport java.time.LocalDateTime;[m
 [m
[32m+[m[32mimport br.com.wta.frete.colaboradores.entity.Transportador; // NOVO IMPORT[m
 import jakarta.persistence.Column;[m
 import jakarta.persistence.Entity;[m
 import jakarta.persistence.FetchType;[m
[32m+[m[32mimport jakarta.persistence.GeneratedValue;[m
[32m+[m[32mimport jakarta.persistence.GenerationType;[m
 import jakarta.persistence.Id;[m
 import jakarta.persistence.JoinColumn;[m
 import jakarta.persistence.ManyToOne;[m
[31m-import jakarta.persistence.MapsId;[m
[31m-import jakarta.persistence.OneToOne;[m
 import jakarta.persistence.Table;[m
 import lombok.AllArgsConstructor;[m
[32m+[m[32mimport lombok.Builder; // Adicionado para uso no Service[m
 import lombok.Data;[m
 import lombok.NoArgsConstructor;[m
 [m
 /**[m
  * Mapeia a tabela 'logistica.fretes'. Representa o leil√£o ou a proposta de[m
[31m- * frete para uma Ordem de Servi√ßo.[m
[32m+[m[32m * frete. A chave prim√°ria agora √© gerada automaticamente (frete_id).[m
  */[m
 @Entity[m
 @Table(name = "fretes", schema = "logistica")[m
 @Data[m
[32m+[m[32m@Builder // √ötil para criar inst√¢ncias no FreteService[m
 @NoArgsConstructor[m
 @AllArgsConstructor[m
 public class Frete {[m
 [m
 	/**[m
[31m-	 * Chave prim√°ria (ordem_servico_id BIGINT). Relacionamento 1:1 com[m
[31m-	 * OrdemServico, usando a chave compartilhada (@MapsId).[m
[32m+[m	[32m * Chave prim√°ria autoincrementada (frete_id SERIAL PRIMARY KEY).[m
 	 */[m
 	@Id[m
[31m-	@Column(name = "ordem_servico_id")[m
[31m-	private Long ordemServicoId;[m
[32m+[m	[32m@GeneratedValue(strategy = GenerationType.IDENTITY)[m
[32m+[m	[32m@Column(name = "frete_id")[m
[32m+[m	[32mprivate Long freteId;[m
[32m+[m
[32m+[m	[32m// --- RELACIONAMENTOS (Foreign Keys) ---[m
 [m
 	/**[m
[31m-	 * Relacionamento Um-para-Um com OrdemServico.[m
[32m+[m	[32m * Ordem de Servi√ßo √† qual este frete est√° ligado (ordem_servico_id BIGINT NOT[m
[32m+[m	[32m * NULL).[m
 	 */[m
[31m-	@OneToOne(fetch = FetchType.LAZY)[m
[31m-	@MapsId // Mapeia a chave prim√°ria (ordem_servico_id) para a PK de OrdemServico[m
[32m+[m	[32m@ManyToOne(fetch = FetchType.LAZY)[m
 	@JoinColumn(name = "ordem_servico_id", nullable = false)[m
 	private OrdemServico ordemServico;[m
 [m
[31m-	// --- Relacionamentos (Chaves Estrangeiras) ---[m
[31m-[m
 	/**[m
[31m-	 * Modalidade de frete selecionada (modalidade_id INTEGER NOT NULL).[m
[31m-	 * Relacionamento Many-to-One com ModalidadeFrete.[m
[32m+[m	[32m * Modalidade do frete (modalidade_id INTEGER NOT NULL).[m
[32m+[m	[32m * Nota: O nome do campo foi ajustado para 'modalidade' para consist√™ncia.[m
 	 */[m
 	@ManyToOne(fetch = FetchType.LAZY)[m
 	@JoinColumn(name = "modalidade_id", nullable = false)[m
 	private ModalidadeFrete modalidade;[m
 [m
 	/**[m
[31m-	 * Status atual do leil√£o ou cota√ß√£o (status_leilao_id INTEGER NOT NULL).[m
[31m-	 * Relacionamento Many-to-One com StatusLeilao.[m
[32m+[m	[32m * Status atual do leil√£o (status_leilao_id INTEGER NOT NULL).[m
 	 */[m
 	@ManyToOne(fetch = FetchType.LAZY)[m
 	@JoinColumn(name = "status_leilao_id", nullable = false)[m
 	private StatusLeilao statusLeilao;[m
 [m
[31m-	// --- Detalhes do Frete ---[m
[31m-[m
 	/**[m
[31m-	 * Prazo para o encerramento do leil√£o/propostas (TIMESTAMP WITH TIME ZONE NOT[m
[31m-	 * NULL).[m
[32m+[m	[32m * Transportador que ganhou o leil√£o (transportador_selecionado_id BIGINT).[m
[32m+[m	[32m * Este campo √© NULO se o leil√£o ainda n√£o foi finalizado ou n√£o teve vencedor.[m
 	 */[m
[31m-	@Column(name = "prazo_encerramento", nullable = false, columnDefinition = "TIMESTAMP WITH TIME ZONE")[m
[31m-	private ZonedDateTime prazoEncerramento;[m
[31m-[m
[31m-	/**[m
[31m-	 * Valor inicial sugerido pelo cliente (NUMERIC(10, 2)).[m
[31m-	 */[m
[31m-	@Column(name = "valor_inicial_proposto", precision = 10, scale = 2)[m
[31m-	private BigDecimal valorInicialProposto;[m
[32m+[m	[32m@ManyToOne(fetch = FetchType.LAZY)[m
[32m+[m	[32m@JoinColumn(name = "transportador_selecionado_id", nullable = true)[m
[32m+[m	[32mprivate Transportador transportadorSelecionado;[m
 [m
[31m-	/**[m
[31m-	 * Valor final do frete aceito (NUMERIC(10, 2)). Ser√° preenchido ap√≥s a[m
[31m-	 * aceita√ß√£o de um lance.[m
[31m-	 */[m
[31m-	@Column(name = "valor_final_aceito", precision = 10, scale = 2)[m
[31m-	private BigDecimal valorFinalAceito;[m
[32m+[m	[32m// --- CAMPOS DE DADOS DA NEGOCIA√á√ÉO ---[m
 [m
 	/**[m
[31m-	 * Informa√ß√£o adicional sobre o tipo de embalagem, se aplic√°vel (VARCHAR(50)).[m
[32m+[m	[32m * Data e hora de expira√ß√£o da negocia√ß√£o (TIMESTAMP WITH TIME ZONE).[m
 	 */[m
[31m-	@Column(name = "tipo_embalagem", length = 50)[m
[31m-	private String tipoEmbalagem;[m
[31m-[m
[31m-	// --- NOVOS CAMPOS ADICIONADOS (Corre√ß√£o para FreteService) ---[m
[32m+[m	[32m@Column(name = "data_expiracao_negociacao")[m
[32m+[m	[32mprivate LocalDateTime dataExpiracaoNegociacao;[m
 [m
 	/**[m
[31m-	 * Dist√¢ncia rodovi√°ria em Km (NUMERIC(8, 2)).[m
[32m+[m	[32m * Dist√¢ncia rodovi√°ria em Km (NUMERIC(10, 2)).[m
 	 */[m
[31m-	@Column(name = "distancia_km", precision = 8, scale = 2)[m
[32m+[m	[32m@Column(name = "distancia_km", precision = 10, scale = 2)[m
 	private BigDecimal distanciaKm;[m
 [m
 	/**[m
[36m@@ -117,9 +104,35 @@[m [mpublic class Frete {[m
 	private BigDecimal custoBaseMercado;[m
 [m
 	/**[m
[31m-	 * Data e hora de expira√ß√£o da negocia√ß√£o/leil√£o (TIMESTAMP WITH TIME ZONE).[m
[32m+[m	[32m * Peso total da carga em Kg (Necess√°rio para c√°lculo ANTT).[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "peso_total_kg", precision = 10, scale = 2)[m
[32m+[m	[32mprivate BigDecimal pesoTotalKg;[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Valor inicial proposto pelo cliente/sistema (Para refer√™ncia).[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "valor_inicial_proposto", precision = 10, scale = 2)[m
[32m+[m	[32mprivate BigDecimal valorInicialProposto;[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Valor final do frete aceito (NUMERIC(10, 2)). Ser√° o valor do lance vencedor.[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "valor_final_aceito", precision = 10, scale = 2)[m
[32m+[m	[32mprivate BigDecimal valorFinalAceito;[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Informa√ß√£o adicional sobre o tipo de embalagem (VARCHAR(50)).[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "tipo_embalagem", length = 50)[m
[32m+[m	[32mprivate String tipoEmbalagem;[m
[32m+[m
[32m+[m	[32m// --- M√âTODOS AUXILIARES ---[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Getter auxiliar para o ID da Ordem de Servi√ßo, muito usado no FreteService.[m
 	 */[m
[31m-	@Column(name = "data_expiracao_negociacao", columnDefinition = "TIMESTAMP WITH TIME ZONE")[m
[31m-	private LocalDateTime dataExpiracaoNegociacao; // Usando LocalDateTime para compatibilidade com o setter no[m
[31m-													// FreteService[m
[32m+[m	[32mpublic Long getOrdemServicoId() {[m
[32m+[m		[32mreturn this.ordemServico != null ? this.ordemServico.getId() : null;[m
[32m+[m	[32m}[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/entity/ItemFrete.java b/src/main/java/br/com/wta/frete/logistica/entity/ItemFrete.java[m
[1mindex e667814..795b251 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/entity/ItemFrete.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/entity/ItemFrete.java[m
[36m@@ -10,6 +10,7 @@[m [mimport java.math.BigDecimal;[m
 /**[m
  * Mapeia a tabela 'logistica.itens_frete'. Detalha os materiais ou produtos que[m
  * comp√µem um Frete.[m
[32m+[m[32m * * CORRE√á√ïES: Alinhamento de nomes de colunas com o schema SQL.[m
  */[m
 @Entity[m
 @Table(name = "itens_frete", schema = "logistica")[m
[36m@@ -19,42 +20,52 @@[m [mimport java.math.BigDecimal;[m
 public class ItemFrete {[m
 [m
 	/**[m
[31m-	 * Chave prim√°ria (BIGSERIAL). Mapeado para Long.[m
[32m+[m	[32m * Chave prim√°ria (BIGSERIAL -> SERIAL).[m
[32m+[m	[32m * NOME CORRIGIDO: de 'item_id' para 'item_frete_id'.[m
 	 */[m
 	@Id[m
 	@GeneratedValue(strategy = GenerationType.IDENTITY)[m
[31m-	@Column(name = "item_id")[m
[32m+[m	[32m@Column(name = "item_frete_id")[m
 	private Long id;[m
 [m
 	/**[m
[31m-	 * Chave estrangeira para o Frete (ordem_servico_id BIGINT NOT NULL).[m
[31m-	 * Relacionamento Many-to-One: Muitos Itens para Um Frete.[m
[32m+[m	[32m * Chave estrangeira para o Frete (frete_id INTEGER NOT NULL).[m
[32m+[m	[32m * NOME CORRIGIDO: de 'ordem_servico_id' para 'frete_id'.[m
 	 */[m
 	@ManyToOne(fetch = FetchType.LAZY)[m
[31m-	@JoinColumn(name = "ordem_servico_id", nullable = false)[m
[32m+[m	[32m@JoinColumn(name = "frete_id", nullable = false)[m
 	private Frete frete;[m
 [m
 	/**[m
[31m-	 * Descri√ß√£o do item (VARCHAR(255) NOT NULL).[m
[32m+[m	[32m * Descri√ß√£o do item (TEXT NOT NULL).[m
[32m+[m	[32m * NOME CORRIGIDO: de 'descricao_item' para 'descricao'.[m
 	 */[m
[31m-	@Column(name = "descricao_item", nullable = false, length = 255)[m
[31m-	private String descricaoItem;[m
[32m+[m	[32m@Column(name = "descricao", nullable = false, columnDefinition = "TEXT")[m
[32m+[m	[32mprivate String descricao;[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Tipo do material (VARCHAR(100)).[m
[32m+[m	[32m * NOVO CAMPO: 'tipo_material'.[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "tipo_material", length = 100)[m
[32m+[m	[32mprivate String tipoMaterial;[m
 [m
 	/**[m
 	 * Quantidade em peso do item (NUMERIC(10, 2) NOT NULL).[m
[32m+[m	[32m * NOME CORRIGIDO: de 'quantidade_peso_kg' para 'peso_estimado_kg'.[m
 	 */[m
[31m-	@Column(name = "quantidade_peso_kg", nullable = false, precision = 10, scale = 2)[m
[31m-	private BigDecimal quantidadePesoKg;[m
[32m+[m	[32m@Column(name = "peso_estimado_kg", nullable = false, precision = 10, scale = 2)[m
[32m+[m	[32mprivate BigDecimal pesoEstimadoKg;[m
 [m
 	/**[m
 	 * Volume c√∫bico do item, se aplic√°vel (NUMERIC(10, 2)).[m
[32m+[m	[32m * NOME CORRIGIDO: de 'volume_m3' para 'volume_estimado_m3'.[m
 	 */[m
[31m-	@Column(name = "volume_m3", precision = 10, scale = 2)[m
[31m-	private BigDecimal volumeM3;[m
[32m+[m	[32m@Column(name = "volume_estimado_m3", precision = 10, scale = 2)[m
[32m+[m	[32mprivate BigDecimal volumeEstimadoM3;[m
 [m
 	/**[m
[31m-	 * Valor unit√°rio estimado do item (NUMERIC(10, 2)).[m
[32m+[m	[32m * CAMPO REMOVIDO: 'valor_estimado_unitario' n√£o existe na tabela SQL.[m
 	 */[m
[31m-	@Column(name = "valor_estimado_unitario", precision = 10, scale = 2)[m
[31m-	private BigDecimal valorEstimadoUnitario;[m
[32m+[m	[32m// private BigDecimal valorEstimadoUnitario;[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/entity/Lance.java b/src/main/java/br/com/wta/frete/logistica/entity/Lance.java[m
[1mindex 8c0d2c8..55278b9 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/entity/Lance.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/entity/Lance.java[m
[36m@@ -1,70 +1,79 @@[m
[32m+[m[32m// Caminho: src/main/java/br/com/wta/frete/logistica/entity/Lance.java[m
 package br.com.wta.frete.logistica.entity;[m
 [m
[31m-import jakarta.persistence.*;[m
[31m-import lombok.Data;[m
[31m-import lombok.NoArgsConstructor;[m
[31m-import lombok.AllArgsConstructor;[m
[31m-[m
 import java.math.BigDecimal;[m
[31m-import java.time.ZonedDateTime;[m
[32m+[m[32mimport java.time.LocalDateTime;[m
 [m
 import br.com.wta.frete.colaboradores.entity.Transportador;[m
[32m+[m[32mimport jakarta.persistence.Column;[m
[32m+[m[32mimport jakarta.persistence.Entity;[m
[32m+[m[32mimport jakarta.persistence.FetchType;[m
[32m+[m[32mimport jakarta.persistence.GeneratedValue;[m
[32m+[m[32mimport jakarta.persistence.GenerationType;[m
[32m+[m[32mimport jakarta.persistence.Id;[m
[32m+[m[32mimport jakarta.persistence.JoinColumn;[m
[32m+[m[32mimport jakarta.persistence.ManyToOne;[m
[32m+[m[32mimport jakarta.persistence.Table;[m
[32m+[m[32mimport lombok.AllArgsConstructor;[m
[32m+[m[32mimport lombok.Builder;[m
[32m+[m[32mimport lombok.Data;[m
[32m+[m[32mimport lombok.NoArgsConstructor;[m
 [m
 /**[m
[31m- * Mapeia a tabela 'logistica.lances'. Registra as propostas de pre√ßo feitas[m
[31m- * pelos Transportadores para um Frete.[m
[32m+[m[32m * Mapeia a tabela 'logistica.lances'. Registra a proposta de pre√ßo[m
[32m+[m[32m * de um Transportador para um Frete (Leil√£o Reverso).[m
  */[m
 @Entity[m
 @Table(name = "lances", schema = "logistica")[m
 @Data[m
[32m+[m[32m@Builder[m
 @NoArgsConstructor[m
 @AllArgsConstructor[m
 public class Lance {[m
 [m
[31m-	/**[m
[31m-	 * Chave prim√°ria (BIGSERIAL). Mapeado para Long.[m
[31m-	 */[m
 	@Id[m
 	@GeneratedValue(strategy = GenerationType.IDENTITY)[m
 	@Column(name = "lance_id")[m
 	private Long id;[m
 [m
[31m-	// --- Relacionamentos (Chaves Estrangeiras) ---[m
[31m-[m
 	/**[m
[31m-	 * Frete ao qual este lance se refere (ordem_servico_id BIGINT NOT NULL).[m
[31m-	 * Relacionamento Many-to-One com Frete.[m
[32m+[m	[32m * Refer√™ncia ao Frete que est√° sendo leiloado.[m
[32m+[m	[32m * CORRE√á√ÉO: Coluna ajustada para 'frete_id'.[m
 	 */[m
 	@ManyToOne(fetch = FetchType.LAZY)[m
[31m-	@JoinColumn(name = "ordem_servico_id", nullable = false)[m
[32m+[m	[32m@JoinColumn(name = "frete_id", nullable = false)[m
 	private Frete frete;[m
 [m
 	/**[m
[31m-	 * Transportador que fez o lance (transportador_pessoa_id BIGINT NOT NULL).[m
[31m-	 * Relacionamento Many-to-One com Transportador.[m
[32m+[m	[32m * Refer√™ncia ao Transportador que submeteu o lance.[m
[32m+[m	[32m * CORRE√á√ÉO: Coluna ajustada para 'transportador_id'.[m
 	 */[m
 	@ManyToOne(fetch = FetchType.LAZY)[m
[31m-	@JoinColumn(name = "transportador_pessoa_id", nullable = false)[m
[32m+[m	[32m@JoinColumn(name = "transportador_id", nullable = false)[m
 	private Transportador transportador;[m
 [m
[31m-	// --- Detalhes do Lance ---[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Valor monet√°rio proposto pelo transportador (NUMERIC(10, 2)).[m
[32m+[m	[32m * CORRE√á√ÉO: Campo e coluna ajustados para 'valor_lance'.[m
[32m+[m	[32m */[m
[32m+[m	[32m@Column(name = "valor_lance", precision = 10, scale = 2, nullable = false)[m
[32m+[m	[32mprivate BigDecimal valorLance;[m
 [m
 	/**[m
[31m-	 * Valor proposto pelo Transportador (NUMERIC(10, 2) NOT NULL).[m
[32m+[m	[32m * Data e hora da submiss√£o/atualiza√ß√£o do lance.[m
 	 */[m
[31m-	@Column(name = "valor_proposto", nullable = false, precision = 10, scale = 2)[m
[31m-	private BigDecimal valorProposto;[m
[32m+[m	[32m@Column(name = "data_lance")[m
[32m+[m	[32mprivate LocalDateTime dataLance;[m
 [m
 	/**[m
[31m-	 * Data e hora em que o lance foi registrado (TIMESTAMP WITH TIME ZONE DEFAULT[m
[31m-	 * CURRENT_TIMESTAMP).[m
[32m+[m	[32m * Indica se este lance foi o vencedor do leil√£o (is_vencedor BOOLEAN).[m
 	 */[m
[31m-	@Column(name = "data_lance", columnDefinition = "TIMESTAMP WITH TIME ZONE")[m
[31m-	private ZonedDateTime dataLance = ZonedDateTime.now();[m
[32m+[m	[32m@Column(name = "is_vencedor")[m
[32m+[m	[32mprivate boolean vencedor;[m
 [m
 	/**[m
[31m-	 * Indica se o lance foi o lance vencedor (BOOLEAN NOT NULL DEFAULT false).[m
[32m+[m	[32m * Motivo do cancelamento (TEXT). NOVO CAMPO[m
 	 */[m
[31m-	@Column(name = "vencedor", nullable = false)[m
[31m-	private Boolean vencedor = false;[m
[32m+[m	[32m@Column(name = "motivo_cancelamento", columnDefinition = "TEXT")[m
[32m+[m	[32mprivate String motivoCancelamento;[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/repository/FreteRepository.java b/src/main/java/br/com/wta/frete/logistica/repository/FreteRepository.java[m
[1mindex 7bf91be..61ad39b 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/repository/FreteRepository.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/repository/FreteRepository.java[m
[36m@@ -5,11 +5,12 @@[m [mimport org.springframework.stereotype.Repository;[m
 [m
 import br.com.wta.frete.logistica.entity.Frete;[m
 [m
[32m+[m[32mimport java.time.LocalDateTime;[m
 import java.util.List;[m
 [m
 /**[m
  * Reposit√≥rio para a entidade Frete (logistica.fretes). A chave prim√°ria √© o[m
[31m- * ordem_servico_id (Long).[m
[32m+[m[32m * **frete_id** (Long) (Autoincrementado).[m
  */[m
 @Repository[m
 public interface FreteRepository extends JpaRepository<Frete, Long> {[m
[36m@@ -23,4 +24,18 @@[m [mpublic interface FreteRepository extends JpaRepository<Frete, Long> {[m
 	 * Busca fretes pela modalidade (ID).[m
 	 */[m
 	List<Frete> findByModalidadeId(Integer modalidadeId);[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * NOVO M√âTODO: Busca todos os fretes que expiraram e ainda est√£o abertos.[m
[32m+[m	[32m * * @param now O momento atual (LocalDateTime.now()).[m
[32m+[m	[32m *[m[41m [m
[32m+[m	[32m * @param nomeStatusAberto O status que indica que o leil√£o est√° ativo para[m
[32m+[m	[32m *                         lances (ex: "AGUARDANDO_LANCES").[m
[32m+[m	[32m * @return Lista de Fretes expirados para processamento.[m
[32m+[m	[32m */[m
[32m+[m	[32mList<Frete> findByDataExpiracaoNegociacaoBeforeAndStatusLeilaoNomeStatus(LocalDateTime now,[m
[32m+[m			[32mString nomeStatusAberto);[m
[32m+[m
[32m+[m	[32m// M√©todo para buscar status, assumindo que StatusLeilao √© uma entidade separada[m
[32m+[m	[32m// (A inje√ß√£o do StatusLeilaoRepository ser√° feita no Service)[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/repository/ItemFreteRepository.java b/src/main/java/br/com/wta/frete/logistica/repository/ItemFreteRepository.java[m
[1mindex 57cbb50..8facbd3 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/repository/ItemFreteRepository.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/repository/ItemFreteRepository.java[m
[36m@@ -1,6 +1,8 @@[m
[32m+[m[32m// Caminho: src/main/java/br/com/wta/frete/logistica/repository/ItemFreteRepository.java[m
 package br.com.wta.frete.logistica.repository;[m
 [m
 import org.springframework.data.jpa.repository.JpaRepository;[m
[32m+[m[32mimport org.springframework.data.jpa.repository.Query; // NOVO IMPORT[m
 import org.springframework.stereotype.Repository;[m
 [m
 import br.com.wta.frete.logistica.entity.ItemFrete;[m
[36m@@ -14,7 +16,10 @@[m [mimport java.util.List;[m
 public interface ItemFreteRepository extends JpaRepository<ItemFrete, Long> {[m
 [m
 	/**[m
[31m-	 * Busca todos os itens de um Frete espec√≠fico (usando a ordem_servico_id).[m
[32m+[m	[32m * Busca todos os itens de um Frete espec√≠fico, filtrando pelo ID da Ordem de[m
[32m+[m	[32m * Servi√ßo.[m
[32m+[m	[32m * CORRE√á√ÉO: Usando @Query para navega√ß√£o expl√≠cita i.frete.ordemServico.id.[m
 	 */[m
[31m-	List<ItemFrete> findByFreteOrdemServicoId(Long ordemServicoId);[m
[32m+[m	[32m@Query("SELECT i FROM ItemFrete i WHERE i.frete.ordemServico.id = :ordemServicoId")[m
[32m+[m	[32mList<ItemFrete> findByFreteOrdemServico_Id(Long ordemServicoId);[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/repository/LanceRepository.java b/src/main/java/br/com/wta/frete/logistica/repository/LanceRepository.java[m
[1mindex da5f288..ff0e313 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/repository/LanceRepository.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/repository/LanceRepository.java[m
[36m@@ -1,11 +1,14 @@[m
[32m+[m[32m// Caminho: src/main/java/br/com/wta/frete/logistica/repository/LanceRepository.java[m
 package br.com.wta.frete.logistica.repository;[m
 [m
 import org.springframework.data.jpa.repository.JpaRepository;[m
[32m+[m[32mimport org.springframework.data.jpa.repository.Query;[m
 import org.springframework.stereotype.Repository;[m
 [m
 import br.com.wta.frete.logistica.entity.Lance;[m
 [m
 import java.util.List;[m
[32m+[m[32mimport java.util.Optional;[m
 [m
 /**[m
  * Reposit√≥rio para a entidade Lance (logistica.lances).[m
[36m@@ -14,18 +17,36 @@[m [mimport java.util.List;[m
 public interface LanceRepository extends JpaRepository<Lance, Long> {[m
 [m
 	/**[m
[31m-	 * Busca todos os lances feitos para um Frete espec√≠fico (usando o ID da Ordem[m
[31m-	 * de Servi√ßo).[m
[32m+[m	[32m * Busca todos os lances feitos para um Frete espec√≠fico (usando a PK da[m
[32m+[m	[32m * OrdemServico).[m
 	 */[m
[31m-	List<Lance> findByFreteOrdemServicoId(Long ordemServicoId);[m
[32m+[m	[32m@Query("SELECT l FROM Lance l WHERE l.frete.ordemServico.id = :ordemServicoId")[m
[32m+[m	[32mList<Lance> findByFreteOrdemServico_Id(Long ordemServicoId);[m
 [m
 	/**[m
[31m-	 * Busca os lances feitos por um Transportador espec√≠fico, ordenados pela data.[m
[32m+[m	[32m * Busca o lance vencedor de um Frete.[m
[32m+[m	[32m * CORRE√á√ÉO: A query JPQL estava correta, o erro era de outra query.[m
 	 */[m
[31m-	List<Lance> findByTransportadorPessoaIdOrderByDataLanceDesc(Long transportadorPessoaId);[m
[32m+[m	[32m@Query("SELECT l FROM Lance l WHERE l.frete.ordemServico.id = :ordemServicoId AND l.vencedor = TRUE")[m
[32m+[m	[32mLance findByFreteOrdemServico_IdAndVencedorTrue(Long ordemServicoId);[m
 [m
 	/**[m
[31m-	 * Busca o lance vencedor de um Frete.[m
[32m+[m	[32m * Encontra o lance de menor valor para um Frete (o melhor lance no Leil√£o[m
[32m+[m	[32m * Reverso).[m
[32m+[m	[32m * CORRE√á√ÉO: 'l.valorProposto' alterado para 'l.valorLance'.[m
[32m+[m	[32m * O nome do m√©todo Spring Data tamb√©m deve ser ajustado, embora a query[m
[32m+[m	[32m * expl√≠cita (@Query) seja a priorit√°ria.[m
[32m+[m	[32m */[m
[32m+[m	[32m// O nome do m√©todo ideal seria:[m
[32m+[m	[32m// findTopByFreteOrdemServico_IdOrderByValorLanceAsc[m
[32m+[m	[32m@Query("SELECT l FROM Lance l WHERE l.frete.ordemServico.id = :ordemServicoId ORDER BY l.valorLance ASC LIMIT 1")[m
[32m+[m	[32mOptional<Lance> findTopByFreteOrdemServico_IdOrderByValorPropostoAsc(Long ordemServicoId);[m
[32m+[m
[32m+[m	[32m/**[m
[32m+[m	[32m * Encontra o lance espec√≠fico de um Transportador para um Frete.[m
[32m+[m	[32m * CORRE√á√ÉO: A query JPQL estava correta.[m
 	 */[m
[31m-	Lance findByFreteOrdemServicoIdAndVencedorTrue(Long ordemServicoId);[m
[32m+[m	[32m@Query("SELECT l FROM Lance l WHERE l.frete.ordemServico.id = :ordemServicoId AND l.transportador.pessoaId = :transportadorPessoaId")[m
[32m+[m	[32mOptional<Lance> findByFreteOrdemServico_IdAndTransportadorPessoaId(Long ordemServicoId,[m
[32m+[m			[32mLong transportadorPessoaId);[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/service/FreteService.java b/src/main/java/br/com/wta/frete/logistica/service/FreteService.java[m
[1mindex eec6f58..597f7a7 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/service/FreteService.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/service/FreteService.java[m
[36m@@ -1,11 +1,16 @@[m
[32m+[m[32m// Caminho: src/main/java/br/com/wta/frete/logistica/service/FreteService.java[m
 package br.com.wta.frete.logistica.service;[m
 [m
 import java.math.BigDecimal;[m
 import java.math.RoundingMode;[m
 import java.time.LocalDateTime;[m
 import java.util.List;[m
[32m+[m[32mimport java.util.Optional;[m
 import java.util.stream.Collectors;[m
 [m
[32m+[m[32mimport org.slf4j.Logger;[m
[32m+[m[32mimport org.slf4j.LoggerFactory;[m
[32m+[m[32mimport org.springframework.scheduling.annotation.Scheduled;[m
 import org.springframework.stereotype.Service;[m
 import org.springframework.transaction.annotation.Transactional;[m
 [m
[36m@@ -13,11 +18,13 @@[m [mimport br.com.wta.frete.logistica.controller.dto.FreteResponse;[m
 import br.com.wta.frete.logistica.controller.dto.ItemFreteRequest;[m
 import br.com.wta.frete.logistica.entity.Frete;[m
 import br.com.wta.frete.logistica.entity.ItemFrete;[m
[32m+[m[32mimport br.com.wta.frete.logistica.entity.Lance;[m
 import br.com.wta.frete.logistica.entity.ModalidadeFrete;[m
 import br.com.wta.frete.logistica.entity.OrdemServico;[m
 import br.com.wta.frete.logistica.entity.StatusLeilao;[m
 import br.com.wta.frete.logistica.repository.FreteRepository;[m
 import br.com.wta.frete.logistica.repository.ItemFreteRepository;[m
[32m+[m[32mimport br.com.wta.frete.logistica.repository.LanceRepository;[m
 import br.com.wta.frete.logistica.repository.ModalidadeFreteRepository;[m
 import br.com.wta.frete.logistica.repository.StatusLeilaoRepository;[m
 import br.com.wta.frete.logistica.service.mapper.FreteMapper;[m
[36m@@ -27,194 +34,283 @@[m [mimport br.com.wta.frete.shared.service.GeoService;[m
 [m
 /**[m
  * Servi√ßo respons√°vel por criar o objeto Frete a partir de uma Ordem de Servi√ßo[m
[31m- * (OS).[m
[31m- * Orquestra o c√°lculo de dist√¢ncia, pre√ßo ANTT e inicia o ciclo de leil√£o.[m
[32m+[m[32m * (OS), orquestrar os c√°lculos e gerenciar o ciclo de vida do leil√£o (incluindo[m
[32m+[m[32m * a finaliza√ß√£o autom√°tica).[m
  */[m
 @Service[m
 public class FreteService {[m
 [m
[31m-    private final FreteRepository freteRepository;[m
[31m-    private final FreteMapper freteMapper;[m
[31m-    private final ItemFreteRepository itemFreteRepository;[m
[31m-    private final ItemFreteMapper itemFreteMapper;[m
[31m-    private final GeoService geoService;[m
[31m-    private final AnttParametroService anttService;[m
[31m-    private final StatusLeilaoRepository statusLeilaoRepository;[m
[31m-    private final ModalidadeFreteRepository modalidadeFreteRepository;[m
[31m-[m
[31m-    // Inje√ß√£o de depend√™ncias via construtor[m
[31m-    public FreteService([m
[31m-            FreteRepository freteRepository,[m
[31m-            FreteMapper freteMapper,[m
[31m-            ItemFreteRepository itemFreteRepository,[m
[31m-            ItemFreteMapper itemFreteMapper,[m
[31m-            GeoService geoService,[m
[31m-            AnttParametroService anttService,[m
[31m-            StatusLeilaoRepository statusLeilaoRepository,[m
[31m-            ModalidadeFreteRepository modalidadeFreteRepository) {[m
[31m-        this.freteRepository = freteRepository;[m
[31m-        this.freteMapper = freteMapper;[m
[31m-        this.itemFreteRepository = itemFreteRepository;[m
[31m-        this.itemFreteMapper = itemFreteMapper;[m
[31m-        this.geoService = geoService;[m
[31m-        this.anttService = anttService;[m
[31m-        this.statusLeilaoRepository = statusLeilaoRepository;[m
[31m-        this.modalidadeFreteRepository = modalidadeFreteRepository;[m
[31m-    }[m
[31m-[m
[31m-    /**[m
[31m-     * M√âTODO CENTRAL: Inicia o ciclo de leil√£o/cota√ß√£o criando a entidade Frete.[m
[31m-     * <p>[m
[31m-     * Respons√°vel pela orquestra√ß√£o da cria√ß√£o e persist√™ncia do Frete e seus[m
[31m-     * itens,[m
[31m-     * delegando todos os c√°lculos e infer√™ncias de regras de neg√≥cio (como a[m
[31m-     * precifica√ß√£o)[m
[31m-     * a m√©todos auxiliares para aderir ao SRP.[m
[31m-     * </p>[m
[31m-     *[m
[31m-     * @param ordemServico           A Ordem de Servi√ßo rec√©m-criada.[m
[31m-     * @param itensFreteRequests     DTOs dos itens a serem transportados.[m
[31m-     * @param nomeModalidadeDesejada Nome da Modalidade de Frete a ser usada no[m
[31m-     *                               Frete.[m
[31m-     * @return FreteResponse com os dados do leil√£o inicial.[m
[31m-     * @throws ResourceNotFoundException Se o Status de Leil√£o ou a Modalidade de[m
[31m-     *                                   Frete desejada n√£o forem encontrados.[m
[31m-     */[m
[31m-    @Transactional[m
[31m-    public FreteResponse criarFrete([m
[31m-            OrdemServico ordemServico,[m
[31m-            List<ItemFreteRequest> itensFreteRequests,[m
[31m-            String nomeModalidadeDesejada) { // <--- NOVO PAR√ÇMETRO: Torna a escolha da modalidade flex√≠vel[m
[31m-[m
[31m-        // 1. C√ÅLCULO DE PAR√ÇMETROS E INFER√äNCIA DE RECURSOS (L√≥gica delegada)[m
[31m-        FreteParametrosCalculados params = calcularParametrosIniciais([m
[31m-                ordemServico,[m
[31m-                itensFreteRequests,[m
[31m-                nomeModalidadeDesejada);[m
[31m-[m
[31m-        // 2. CRIA√á√ÉO DA ENTIDADE FRETE (Orquestra√ß√£o)[m
[31m-        Frete novoFrete = new Frete();[m
[31m-        novoFrete.setOrdemServico(ordemServico);[m
[31m-[m
[31m-        // Aplica os par√¢metros calculados/inferidos[m
[31m-        novoFrete.setModalidade(params.modalidade);[m
[31m-        novoFrete.setStatusLeilao(params.statusInicial);[m
[31m-        novoFrete.setDistanciaKm(params.distanciaKm);[m
[31m-        novoFrete.setAnttPisoMinimo(params.anttPisoMinimo);[m
[31m-        novoFrete.setPrecoSugerido(params.precoSugerido);[m
[31m-        novoFrete.setCustoBaseMercado(params.custoBaseMercado);[m
[31m-        novoFrete.setDataExpiracaoNegociacao(params.dataExpiracaoNegociacao);[m
[31m-[m
[31m-        // ** (Os campos que antes estavam no Frete.java mas n√£o foram mais fornecidos[m
[31m-        // s√£o omitidos daqui. Ex: setTipoEmbalagem) **[m
[31m-[m
[31m-        Frete freteSalvo = freteRepository.save(novoFrete);[m
[31m-[m
[31m-        // 3. CRIA√á√ÉO E ASSOCIA√á√ÉO DOS ITENS DE FRETE (L√≥gica delegada)[m
[31m-        salvarItensFrete(freteSalvo, itensFreteRequests);[m
[31m-[m
[31m-        return freteMapper.toResponse(freteSalvo);[m
[31m-    }[m
[31m-[m
[31m-    /**[m
[31m-     * Busca um Frete pelo seu ID.[m
[31m-     */[m
[31m-    @SuppressWarnings("null")[m
[31m-    @Transactional(readOnly = true)[m
[31m-    public FreteResponse buscarPorId(Long id) {[m
[31m-        Frete frete = freteRepository.findById(id)[m
[31m-                .orElseThrow(() -> new ResourceNotFoundException("Frete n√£o encontrado com ID: " + id));[m
[31m-        return freteMapper.toResponse(frete);[m
[31m-    }[m
[31m-[m
[31m-    // --- M√âTODOS AUXILIARES PRIVADOS (Aumento de SRP) ---[m
[31m-[m
[31m-    /**[m
[31m-     * Estrutura interna para encapsular todos os par√¢metros calculados/inferidos.[m
[31m-     */[m
[31m-    private record FreteParametrosCalculados([m
[31m-            BigDecimal pesoTotalKg,[m
[31m-            BigDecimal distanciaKm,[m
[31m-            BigDecimal anttPisoMinimo,[m
[31m-            BigDecimal precoSugerido,[m
[31m-            BigDecimal custoBaseMercado,[m
[31m-            LocalDateTime dataExpiracaoNegociacao,[m
[31m-            StatusLeilao statusInicial,[m
[31m-            ModalidadeFrete modalidade) {[m
[31m-    }[m
[31m-[m
[31m-    /**[m
[31m-     * Responsabilidade: Realiza todos os c√°lculos e infer√™ncias de regras de[m
[31m-     * neg√≥cio[m
[31m-     * (peso, dist√¢ncia, pre√ßos, lookup de entidades mestre).[m
[31m-     */[m
[31m-    private FreteParametrosCalculados calcularParametrosIniciais([m
[31m-            OrdemServico ordemServico,[m
[31m-            List<ItemFreteRequest> itensFreteRequests,[m
[31m-            String nomeModalidadeDesejada) {[m
[31m-[m
[31m-        // 1. C√ÅLCULO DE RECURSOS E DIST√ÇNCIA[m
[31m-        BigDecimal pesoTotalKg = calcularPesoTotal(itensFreteRequests);[m
[31m-        BigDecimal distanciaKm = geoService.calcularDistanciaRodoviaria([m
[31m-                ordemServico.getCepColeta(),[m
[31m-                ordemServico.getCepDestino());[m
[31m-[m
[31m-        // 2. C√ÅLCULO DE PRE√áOS BASE (LEGALIDADE)[m
[31m-        BigDecimal anttPisoMinimo = anttService.calcularPisoMinimo(distanciaKm, pesoTotalKg);[m
[31m-[m
[31m-        // 3. OBTEN√á√ÉO DE ENTIDADES MESTRAS (Status e Modalidade)[m
[31m-        StatusLeilao statusInicial = buscarStatusLeilao("AGUARDANDO_LANCES");[m
[31m-[m
[31m-        // FLEXIBILIDADE: A modalidade √© determinada pelo par√¢metro de entrada[m
[31m-        ModalidadeFrete modalidade = buscarModalidadeFrete(nomeModalidadeDesejada);[m
[31m-[m
[31m-        // 4. L√≥gica de Pre√ßo Sugerido (Mercado)[m
[31m-        // Exemplo: 20% acima do piso ANTT[m
[31m-        BigDecimal precoSugerido = anttPisoMinimo.multiply(new BigDecimal("1.20")).setScale(2, RoundingMode.HALF_UP);[m
[31m-        BigDecimal custoBaseMercado = precoSugerido;[m
[31m-[m
[31m-        // 5. Define a data de expira√ß√£o[m
[31m-        LocalDateTime dataExpiracaoNegociacao = LocalDateTime.now().plusHours(48);[m
[31m-[m
[31m-        return new FreteParametrosCalculados([m
[31m-                pesoTotalKg,[m
[31m-                distanciaKm,[m
[31m-                anttPisoMinimo,[m
[31m-                precoSugerido,[m
[31m-                custoBaseMercado,[m
[31m-                dataExpiracaoNegociacao,[m
[31m-                statusInicial,[m
[31m-                modalidade);[m
[31m-    }[m
[31m-[m
[31m-    // ... (restante dos m√©todos auxiliares, buscarPesoTotal, salvarItensFrete,[m
[31m-    // buscarStatusLeilao, buscarModalidadeFrete inalterados) ...[m
[31m-[m
[31m-    private BigDecimal calcularPesoTotal(List<ItemFreteRequest> itens) {[m
[31m-        return itens.stream()[m
[31m-                .map(ItemFreteRequest::pesoEstimadoKg)[m
[31m-                .reduce(BigDecimal.ZERO, BigDecimal::add);[m
[31m-    }[m
[31m-[m
[31m-    @SuppressWarnings("null")[m
[31m-    private void salvarItensFrete(Frete frete, List<ItemFreteRequest> itensFreteRequests) {[m
[31m-        // Mapeia o DTO para a Entidade, associa o Frete, e salva.[m
[31m-        List<ItemFrete> itens = itensFreteRequests.stream()[m
[31m-                .map(itemFreteMapper::toEntity)[m
[31m-                .peek(item -> item.setFrete(frete))[m
[31m-                .collect(Collectors.toList());[m
[31m-[m
[31m-        itemFreteRepository.saveAll(itens);[m
[31m-    }[m
[31m-[m
[31m-    private StatusLeilao buscarStatusLeilao(String nomeStatus) {[m
[31m-        return statusLeilaoRepository.findByNomeStatus(nomeStatus)[m
[31m-                .orElseThrow(() -> new ResourceNotFoundException("Status de Leil√£o n√£o encontrado: " + nomeStatus));[m
[31m-    }[m
[31m-[m
[31m-    private ModalidadeFrete buscarModalidadeFrete(String nomeModalidade) {[m
[31m-        return modalidadeFreteRepository.findByNomeModalidade(nomeModalidade)[m
[31m-                .orElseThrow([m
[31m-                        () -> new ResourceNotFoundException("Modalidade de Frete n√£o encontrada: " + nomeModalidade));[m
[31m-    }[m
[32m+[m[32m        private static final Logger log = LoggerFactory.getLogger(FreteService.class);[m
[32m+[m
[32m+[m[32m        private final FreteRepository freteRepository;[m
[32m+[m[32m        private final FreteMapper freteMapper;[m
[32m+[m[32m        private final ItemFreteRepository itemFreteRepository;[m
[32m+[m[32m        private final ItemFreteMapper itemFreteMapper;[m
[32m+[m[32m        private final GeoService geoService;[m
[32m+[m[32m        private final AnttParametroService anttService;[m
[32m+[m[32m        private final StatusLeilaoRepository statusLeilaoRepository;[m
[32m+[m[32m        private final ModalidadeFreteRepository modalidadeFreteRepository;[m
[32m+[m[32m        private final LanceRepository lanceRepository;[m
[32m+[m
[32m+[m[32m        // Inje√ß√£o de depend√™ncias via construtor[m
[32m+[m[32m        public FreteService([m
[32m+[m[32m                        FreteRepository freteRepository,[m
[32m+[m[32m                        FreteMapper freteMapper,[m
[32m+[m[32m                        ItemFreteRepository itemFreteRepository,[m
[32m+[m[32m                        ItemFreteMapper itemFreteMapper,[m
[32m+[m[32m                        GeoService geoService,[m
[32m+[m[32m                        AnttParametroService anttService,[m
[32m+[m[32m                        StatusLeilaoRepository statusLeilaoRepository,[m
[32m+[m[32m                        ModalidadeFreteRepository modalidadeFreteRepository,[m
[32m+[m[32m                        LanceRepository lanceRepository) {[m
[32m+[m[32m                this.freteRepository = freteRepository;[m
[32m+[m[32m                this.freteMapper = freteMapper;[m
[32m+[m[32m                this.itemFreteRepository = itemFreteRepository;[m
[32m+[m[32m                this.itemFreteMapper = itemFreteMapper;[m
[32m+[m[32m                this.geoService = geoService;[m
[32m+[m[32m                this.anttService = anttService;[m
[32m+[m[32m                this.statusLeilaoRepository = statusLeilaoRepository;[m
[32m+[m[32m                this.modalidadeFreteRepository = modalidadeFreteRepository;[m
[32m+[m[32m                this.lanceRepository = lanceRepository;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * M√âTODO CENTRAL: Inicia o ciclo de leil√£o/cota√ß√£o criando a entidade Frete.[m
[32m+[m[32m         */[m
[32m+[m[32m        @Transactional[m
[32m+[m[32m        public FreteResponse criarFrete([m
[32m+[m[32m                        OrdemServico ordemServico,[m
[32m+[m[32m                        List<ItemFreteRequest> itensFreteRequests,[m
[32m+[m[32m                        String nomeModalidadeDesejada) {[m
[32m+[m
[32m+[m[32m                // 1. C√ÅLCULO DE PAR√ÇMETROS E INFER√äNCIA DE RECURSOS[m
[32m+[m[32m                FreteParametrosCalculados params = calcularParametrosIniciais([m
[32m+[m[32m                                ordemServico,[m
[32m+[m[32m                                itensFreteRequests,[m
[32m+[m[32m                                nomeModalidadeDesejada);[m
[32m+[m
[32m+[m[32m                // 2. CRIA√á√ÉO DA ENTIDADE FRETE[m
[32m+[m[32m                Frete novoFrete = new Frete();[m
[32m+[m
[32m+[m[32m                // [MUDAN√áA APLICADA] O Frete agora tem PK pr√≥pria (frete_id). A linha[m
[32m+[m[32m                // setOrdemServicoId deve ser removida.[m
[32m+[m[32m                // novoFrete.setOrdemServicoId(ordemServico.getId()); // REMOVIDO: PK √©[m
[32m+[m[32m                // autogerada (frete_id)[m
[32m+[m[32m                novoFrete.setOrdemServico(ordemServico);[m
[32m+[m
[32m+[m[32m                // Aplica os par√¢metros calculados/inferidos[m
[32m+[m[32m                novoFrete.setModalidade(params.modalidade);[m
[32m+[m[32m                novoFrete.setStatusLeilao(params.statusInicial);[m
[32m+[m[32m                novoFrete.setDistanciaKm(params.distanciaKm);[m
[32m+[m[32m                novoFrete.setAnttPisoMinimo(params.anttPisoMinimo);[m
[32m+[m[32m                novoFrete.setPrecoSugerido(params.precoSugerido);[m
[32m+[m[32m                novoFrete.setCustoBaseMercado(params.custoBaseMercado);[m
[32m+[m[32m                novoFrete.setDataExpiracaoNegociacao(params.dataExpiracaoNegociacao);[m
[32m+[m
[32m+[m[32m                // Assumindo que o campo abaixo existe no Frete.java:[m
[32m+[m[32m                // novoFrete.setValorInicialProposto(params.custoBaseMercado);[m
[32m+[m[32m                // novoFrete.setTipoEmbalagem("");[m
[32m+[m
[32m+[m[32m                Frete freteSalvo = freteRepository.save(novoFrete);[m
[32m+[m
[32m+[m[32m                // 3. CRIA√á√ÉO E ASSOCIA√á√ÉO DOS ITENS DE FRETE[m
[32m+[m[32m                salvarItensFrete(freteSalvo, itensFreteRequests);[m
[32m+[m
[32m+[m[32m                return freteMapper.toResponse(freteSalvo);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * Busca um Frete pelo seu ID.[m
[32m+[m[32m         */[m
[32m+[m[32m        @SuppressWarnings("null")[m
[32m+[m[32m        @Transactional(readOnly = true)[m
[32m+[m[32m        public FreteResponse buscarPorId(Long id) {[m
[32m+[m[32m                // O m√©todo findById() usa a nova PK: freteId (Long)[m
[32m+[m[32m                Frete frete = freteRepository.findById(id)[m
[32m+[m[32m                                .orElseThrow(() -> new ResourceNotFoundException("Frete n√£o encontrado com ID: " + id));[m
[32m+[m[32m                return freteMapper.toResponse(frete);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // --- M√âTODOS DE FINALIZA√á√ÉO DE LEIL√ÉO (@Scheduled) ---[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * TAREFA AGENDADA: Verifica e finaliza leil√µes de frete que expiraram.[m
[32m+[m[32m         * Rodar√° a cada 60 segundos.[m
[32m+[m[32m         * Deve ter a anota√ß√£o @EnableScheduling na classe principal do projeto.[m
[32m+[m[32m         */[m
[32m+[m[32m        @Scheduled(fixedRate = 60000)[m
[32m+[m[32m        @Transactional[m
[32m+[m[32m        public void finalizarLeiloesExpirados() {[m
[32m+[m[32m                log.info("Iniciando verifica√ß√£o de leil√µes expirados...");[m
[32m+[m
[32m+[m[32m                final String STATUS_ABERTO = "AGUARDANDO_LANCES"; // Status que indica que o leil√£o est√° ativo[m
[32m+[m
[32m+[m[32m                // Busca fretes expirados que ainda est√£o no status de negocia√ß√£o[m
[32m+[m[32m                List<Frete> fretesExpirados = freteRepository[m
[32m+[m[32m                                .findByDataExpiracaoNegociacaoBeforeAndStatusLeilaoNomeStatus([m
[32m+[m[32m                                                LocalDateTime.now(), STATUS_ABERTO);[m
[32m+[m
[32m+[m[32m                if (fretesExpirados.isEmpty()) {[m
[32m+[m[32m                        log.info("Nenhum leil√£o expirado encontrado.");[m
[32m+[m[32m                        return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                log.info("Processando {} leil√µes expirados...", fretesExpirados.size());[m
[32m+[m[32m                fretesExpirados.forEach(this::processarFinalizacao);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * L√≥gica principal para finalizar um frete, selecionando o melhor lance.[m
[32m+[m[32m         * NOTA: Este m√©todo usa frete.getOrdemServicoId(). Assumimos que a entidade[m
[32m+[m[32m         * Frete.java agora possui um getter auxiliar que retorna[m
[32m+[m[32m         * frete.getOrdemServico().getId().[m
[32m+[m[32m         */[m
[32m+[m[32m        private void processarFinalizacao(Frete frete) {[m
[32m+[m[32m                // 1. Busca o melhor lance (o menor valor) para o leil√£o reverso[m
[32m+[m[32m                Optional<Lance> optionalLanceVencedor = lanceRepository[m
[32m+[m[32m                                .findTopByFreteOrdemServico_IdOrderByValorPropostoAsc(frete.getOrdemServicoId());[m
[32m+[m
[32m+[m[32m                if (optionalLanceVencedor.isPresent()) {[m
[32m+[m[32m                        Lance lanceVencedor = optionalLanceVencedor.get();[m
[32m+[m[32m                        finalizarComVencedor(frete, lanceVencedor);[m
[32m+[m[32m                } else {[m
[32m+[m[32m                        finalizarSemLances(frete);[m
[32m+[m[32m                }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * Atualiza o Frete e o Lance quando h√° um vencedor.[m
[32m+[m[32m         */[m
[32m+[m[32m        private void finalizarComVencedor(Frete frete, Lance lanceVencedor) {[m
[32m+[m[32m                try {[m
[32m+[m[32m                        // 1. Atualiza o Lance como vencedor[m
[32m+[m[32m                        lanceVencedor.setVencedor(true);[m
[32m+[m[32m                        lanceRepository.save(lanceVencedor);[m
[32m+[m
[32m+[m[32m                        // 2. Atualiza o Frete[m
[32m+[m[32m                        StatusLeilao statusVencedor = buscarStatusLeilao("ENCERRADO_COM_VENCEDOR");[m
[32m+[m
[32m+[m[32m                        frete.setStatusLeilao(statusVencedor);[m
[32m+[m[32m                        frete.setValorFinalAceito(lanceVencedor.getValorLance());[m
[32m+[m[32m                        freteRepository.save(frete);[m
[32m+[m
[32m+[m[32m                        log.info("Leil√£o {} finalizado com sucesso. Vencedor: Transportador ID {} com lance R$ {}.",[m
[32m+[m[32m                                        frete.getOrdemServicoId(), lanceVencedor.getTransportador().getPessoaId(),[m
[32m+[m[32m                                        lanceVencedor.getValorLance());[m
[32m+[m
[32m+[m[32m                } catch (ResourceNotFoundException e) {[m
[32m+[m[32m                        log.error("Erro fatal ao finalizar leil√£o {}: Status 'ENCERRADO_COM_VENCEDOR' n√£o encontrado no DB. O frete permanece no status AGUARDANDO_LANCES.",[m
[32m+[m[32m                                        frete.getOrdemServicoId(), e);[m
[32m+[m[32m                }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * Atualiza o Frete quando n√£o h√° lances v√°lidos.[m
[32m+[m[32m         */[m
[32m+[m[32m        private void finalizarSemLances(Frete frete) {[m
[32m+[m[32m                try {[m
[32m+[m[32m                        StatusLeilao statusSemLances = buscarStatusLeilao("ENCERRADO_SEM_LANCES");[m
[32m+[m
[32m+[m[32m                        frete.setStatusLeilao(statusSemLances);[m
[32m+[m[32m                        frete.setValorFinalAceito(null);[m
[32m+[m[32m                        freteRepository.save(frete);[m
[32m+[m
[32m+[m[32m                        log.warn("Leil√£o {} finalizado sem lances. Status atualizado para: ENCERRADO_SEM_LANCES.",[m
[32m+[m[32m                                        frete.getOrdemServicoId());[m
[32m+[m
[32m+[m[32m                } catch (ResourceNotFoundException e) {[m
[32m+[m[32m                        log.error("Erro fatal ao finalizar leil√£o {}: Status 'ENCERRADO_SEM_LANCES' n√£o encontrado no DB. O frete permanece no status AGUARDANDO_LANCES.",[m
[32m+[m[32m                                        frete.getOrdemServicoId(), e);[m
[32m+[m[32m                }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // --- M√âTODOS AUXILIARES PRIVADOS (Aumento de SRP) ---[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * Estrutura interna para encapsular todos os par√¢metros calculados/inferidos.[m
[32m+[m[32m         */[m
[32m+[m[32m        private record FreteParametrosCalculados([m
[32m+[m[32m                        BigDecimal pesoTotalKg,[m
[32m+[m[32m                        BigDecimal distanciaKm,[m
[32m+[m[32m                        BigDecimal anttPisoMinimo,[m
[32m+[m[32m                        BigDecimal precoSugerido,[m
[32m+[m[32m                        BigDecimal custoBaseMercado,[m
[32m+[m[32m                        LocalDateTime dataExpiracaoNegociacao,[m
[32m+[m[32m                        StatusLeilao statusInicial,[m
[32m+[m[32m                        ModalidadeFrete modalidade) {[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /**[m
[32m+[m[32m         * Responsabilidade: Realiza todos os c√°lculos e infer√™ncias de regras de[m
[32m+[m[32m         * neg√≥cio (peso, dist√¢ncia, pre√ßos, lookup de entidades mestre).[m
[32m+[m[32m         */[m
[32m+[m[32m        private FreteParametrosCalculados calcularParametrosIniciais([m
[32m+[m[32m                        OrdemServico ordemServico,[m
[32m+[m[32m                        List<ItemFreteRequest> itensFreteRequests,[m
[32m+[m[32m                        String nomeModalidadeDesejada) {[m
[32m+[m
[32m+[m[32m                // 1. C√ÅLCULO DE RECURSOS E DIST√ÇNCIA[m
[32m+[m[32m                BigDecimal pesoTotalKg = calcularPesoTotal(itensFreteRequests);[m
[32m+[m[32m                // Assumindo que o GeoService calcula a dist√¢ncia com base nos CEPs da OS[m
[32m+[m[32m                BigDecimal distanciaKm = geoService.calcularDistanciaRodoviaria([m
[32m+[m[32m                                ordemServico.getCepColeta(),[m
[32m+[m[32m                                ordemServico.getCepDestino());[m
[32m+[m
[32m+[m[32m                // 2. C√ÅLCULO DE PRE√áOS BASE (LEGALIDADE)[m
[32m+[m[32m                // Assume que o AnttParametroService est√° injetado[m
[32m+[m[32m                BigDecimal anttPisoMinimo = anttService.calcularPisoMinimo(distanciaKm, pesoTotalKg);[m
[32m+[m
[32m+[m[32m                // 3. OBTEN√á√ÉO DE ENTIDADES MESTRAS (Status e Modalidade)[m
[32m+[m[32m                StatusLeilao statusInicial = buscarStatusLeilao("AGUARDANDO_LANCES");[m
[32m+[m[32m                ModalidadeFrete modalidade = buscarModalidadeFrete(nomeModalidadeDesejada);[m
[32m+[m
[32m+[m[32m                // 4. L√≥gica de Pre√ßo Sugerido (Mercado)[m
[32m+[m[32m                BigDecimal precoSugerido = anttPisoMinimo.multiply(new BigDecimal("1.20")).setScale(2,[m
[32m+[m[32m                                RoundingMode.HALF_UP);[m
[32m+[m[32m                BigDecimal custoBaseMercado = precoSugerido;[m
[32m+[m
[32m+[m[32m                // 5. Define a data de expira√ß√£o[m
[32m+[m[32m                LocalDateTime dataExpiracaoNegociacao = LocalDateTime.now().plusHours(48);[m
[32m+[m
[32m+[m[32m                return new FreteParametrosCalculados([m
[32m+[m[32m                                pesoTotalKg,[m
[32m+[m[32m                                distanciaKm,[m
[32m+[m[32m                                anttPisoMinimo,[m
[32m+[m[32m                                precoSugerido,[m
[32m+[m[32m                                custoBaseMercado,[m
[32m+[m[32m                                dataExpiracaoNegociacao,[m
[32m+[m[32m                                statusInicial,[m
[32m+[m[32m                                modalidade);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        private BigDecimal calcularPesoTotal(List<ItemFreteRequest> itens) {[m
[32m+[m[32m                return itens.stream()[m
[32m+[m[32m                                .map(ItemFreteRequest::pesoEstimadoKg)[m
[32m+[m[32m                                .reduce(BigDecimal.ZERO, BigDecimal::add);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        @SuppressWarnings("null")[m
[32m+[m[32m        private void salvarItensFrete(Frete frete, List<ItemFreteRequest> itensFreteRequests) {[m
[32m+[m[32m                // Mapeia o DTO para a Entidade, associa o Frete, e salva.[m
[32m+[m[32m                List<ItemFrete> itens = itensFreteRequests.stream()[m
[32m+[m[32m                                .map(itemFreteMapper::toEntity)[m
[32m+[m[32m                                .peek(item -> item.setFrete(frete))[m
[32m+[m[32m                                .collect(Collectors.toList());[m
[32m+[m
[32m+[m[32m                itemFreteRepository.saveAll(itens);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        private StatusLeilao buscarStatusLeilao(String nomeStatus) {[m
[32m+[m[32m                return statusLeilaoRepository.findByNomeStatus(nomeStatus)[m
[32m+[m[32m                                .orElseThrow(() -> new ResourceNotFoundException([m
[32m+[m[32m                                                "Status de Leil√£o n√£o encontrado: " + nomeStatus));[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        private ModalidadeFrete buscarModalidadeFrete(String nomeModalidade) {[m
[32m+[m[32m                return modalidadeFreteRepository.findByNomeModalidade(nomeModalidade)[m
[32m+[m[32m                                .orElseThrow([m
[32m+[m[32m                                                () -> new ResourceNotFoundException([m
[32m+[m[32m                                                                "Modalidade de Frete n√£o encontrada: "[m
[32m+[m[32m                                                                                + nomeModalidade));[m
[32m+[m[32m        }[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/service/mapper/FreteMapper.java b/src/main/java/br/com/wta/frete/logistica/service/mapper/FreteMapper.java[m
[1mindex dc3b8ba..d1c657c 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/service/mapper/FreteMapper.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/service/mapper/FreteMapper.java[m
[36m@@ -8,99 +8,61 @@[m [mimport org.mapstruct.Mappings;[m
 import br.com.wta.frete.logistica.controller.dto.FreteRequest;[m
 import br.com.wta.frete.logistica.controller.dto.FreteResponse;[m
 import br.com.wta.frete.logistica.entity.Frete;[m
[31m-import br.com.wta.frete.logistica.entity.ModalidadeFrete;[m
[31m-import br.com.wta.frete.logistica.entity.StatusLeilao;[m
 [m
 /**[m
[31m- * Mapper para a entidade Frete, respons√°vel por converter entre FreteRequest,[m
[31m- * FreteResponse e a entidade Frete.[m
[32m+[m[32m * Mapeador MapStruct para convers√£o entre DTOs e a entidade Frete.[m
  */[m
 @Mapper(componentModel = "spring")[m
 public interface FreteMapper {[m
 [m
[31m-	/**[m
[31m-	 * Mapeia o DTO de Requisi√ß√£o para a entidade Frete.[m
[31m-	 * * @param request O DTO de requisi√ß√£o do Frete.[m
[31m-	 * [m
[31m-	 * @return A entidade Frete.[m
[31m-	 */[m
[31m-	@Mapping(target = "modalidade", ignore = true)[m
[31m-	@Mapping(target = "statusLeilao", ignore = true)[m
[31m-	@Mapping(target = "ordemServico", ignore = true) // A entidade OrdemServico ser√° associada no Service[m
[31m-	@Mapping(target = "valorFinalAceito", ignore = true) // N√£o existe no Request, ser√° preenchido ap√≥s o leil√£o.[m
[31m-	// Ignorando novos campos, pois eles ser√£o definidos pelo FreteService, n√£o pelo[m
[31m-	// Request[m
[31m-	@Mapping(target = "distanciaKm", ignore = true)[m
[31m-	@Mapping(target = "anttPisoMinimo", ignore = true)[m
[31m-	@Mapping(target = "precoSugerido", ignore = true)[m
[31m-	@Mapping(target = "custoBaseMercado", ignore = true)[m
[31m-	@Mapping(target = "dataExpiracaoNegociacao", ignore = true)[m
[32m+[m	[32m// Mapeamento de FreteRequest para Frete (Entidade) - (Inalterado da √∫ltima[m
[32m+[m	[32m// corre√ß√£o)[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(source = "prazoEncerramento", target = "dataExpiracaoNegociacao"),[m
[32m+[m			[32m@Mapping(target = "pesoTotalKg", ignore = true),[m
[32m+[m			[32m@Mapping(target = "freteId", ignore = true),[m
[32m+[m			[32m@Mapping(target = "ordemServico", ignore = true),[m
[32m+[m			[32m@Mapping(target = "modalidade", ignore = true),[m
[32m+[m			[32m@Mapping(target = "statusLeilao", ignore = true),[m
[32m+[m			[32m@Mapping(target = "transportadorSelecionado", ignore = true),[m
[32m+[m			[32m@Mapping(target = "distanciaKm", ignore = true),[m
[32m+[m			[32m@Mapping(target = "anttPisoMinimo", ignore = true),[m
[32m+[m			[32m@Mapping(target = "precoSugerido", ignore = true),[m
[32m+[m			[32m@Mapping(target = "custoBaseMercado", ignore = true),[m
[32m+[m			[32m@Mapping(target = "valorFinalAceito", ignore = true),[m
[32m+[m			[32m@Mapping(source = "tipoEmbalagem", target = "tipoEmbalagem"),[m
[32m+[m			[32m@Mapping(source = "valorInicialProposto", target = "valorInicialProposto")[m
[32m+[m	[32m})[m
 	Frete toEntity(FreteRequest request);[m
 [m
[31m-	/**[m
[31m-	 * Mapeia a entidade Frete para o DTO de Resposta.[m
[31m-	 * * @param entity A entidade Frete.[m
[31m-	 * [m
[31m-	 * @return O DTO de resposta do Frete.[m
[31m-	 */[m
[32m+[m	[32m// Mapeamento de Frete (Entidade) para FreteResponse[m
 	@Mappings({[m
[32m+[m			[32m@Mapping(source = "freteId", target = "freteId"),[m
[32m+[m			[32m@Mapping(source = "ordemServico.id", target = "ordemServicoId"),[m
[32m+[m			[32m@Mapping(source = "transportadorSelecionado.pessoaId", target = "transportadorSelecionadoId"),[m
 			@Mapping(source = "modalidade.id", target = "modalidadeId"),[m
[32m+[m			[32m@Mapping(source = "modalidade.nomeModalidade", target = "nomeModalidade"),[m
 			@Mapping(source = "statusLeilao.id", target = "statusLeilaoId"),[m
[31m-[m
[31m-			// CORRE√á√ÉO: Mapeamentos adicionados para os novos campos[m
[31m-			@Mapping(source = "distanciaKm", target = "distanciaKm"),[m
[31m-			@Mapping(source = "anttPisoMinimo", target = "anttPisoMinimo"),[m
[31m-			@Mapping(source = "precoSugerido", target = "precoSugerido"),[m
[31m-			@Mapping(source = "custoBaseMercado", target = "custoBaseMercado"),[m
[31m-			@Mapping(source = "dataExpiracaoNegociacao", target = "dataExpiracaoNegociacao")[m
[32m+[m			[32m@Mapping(source = "statusLeilao.nomeStatus", target = "nomeStatusLeilao")[m
 	})[m
 	FreteResponse toResponse(Frete entity);[m
 [m
[31m-	/**[m
[31m-	 * Atualiza uma entidade Frete existente com base nos dados do DTO de[m
[31m-	 * requisi√ß√£o.[m
[31m-	 * * @param request O DTO de requisi√ß√£o com os dados de atualiza√ß√£o.[m
[31m-	 * [m
[31m-	 * @param target A entidade Frete a ser atualizada.[m
[31m-	 */[m
[31m-	@Mapping(target = "ordemServicoId", ignore = true) // Chave prim√°ria n√£o deve ser alterada[m
[31m-	@Mapping(target = "ordemServico", ignore = true)[m
[31m-	@Mapping(target = "modalidade", ignore = true)[m
[31m-	@Mapping(target = "statusLeilao", ignore = true)[m
[31m-	@Mapping(target = "valorFinalAceito", ignore = true) // Deve ser ignorado para n√£o ser sobrescrito pelo valor[m
[31m-															// default (null) do Request.[m
[31m-	// Ignorando novos campos, pois eles n√£o devem ser alterados por um Request[m
[31m-	// simples de atualiza√ß√£o[m
[31m-	@Mapping(target = "distanciaKm", ignore = true)[m
[31m-	@Mapping(target = "anttPisoMinimo", ignore = true)[m
[31m-	@Mapping(target = "precoSugerido", ignore = true)[m
[31m-	@Mapping(target = "custoBaseMercado", ignore = true)[m
[31m-	@Mapping(target = "dataExpiracaoNegociacao", ignore = true)[m
[31m-	void updateEntityFromRequest(FreteRequest request, @MappingTarget Frete target);[m
[31m-[m
[31m-	// --- M√©todos Auxiliares para Relacionamentos ---[m
[31m-[m
[31m-	/**[m
[31m-	 * Converte um ID simples para uma entidade ModalidadeFrete. A l√≥gica de busca[m
[31m-	 * real deve estar no Service.[m
[31m-	 */[m
[31m-	default ModalidadeFrete mapModalidadeFrete(Integer id) {[m
[31m-		if (id == null) {[m
[31m-			return null;[m
[31m-		}[m
[31m-		// Construtor correto: (Integer id, String nomeModalidade)[m
[31m-		return new ModalidadeFrete(id, null);[m
[31m-	}[m
[31m-[m
[31m-	/**[m
[31m-	 * Converte um ID simples para uma entidade StatusLeilao. A l√≥gica de busca real[m
[31m-	 * deve estar no Service.[m
[31m-	 */[m
[31m-	default StatusLeilao mapStatusLeilao(Integer id) {[m
[31m-		if (id == null) {[m
[31m-			return null;[m
[31m-		}[m
[31m-		// Construtor correto: (Integer id, String nomeStatus)[m
[31m-		return new StatusLeilao(id, null);[m
[31m-	}[m
[32m+[m	[32m// Mapeamento de atualiza√ß√£o (updateEntity) - (Inalterado da √∫ltima corre√ß√£o)[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(source = "prazoEncerramento", target = "dataExpiracaoNegociacao"),[m
[32m+[m			[32m@Mapping(target = "pesoTotalKg", ignore = true),[m
[32m+[m			[32m@Mapping(target = "freteId", ignore = true),[m
[32m+[m			[32m@Mapping(target = "ordemServico", ignore = true),[m
[32m+[m			[32m@Mapping(target = "modalidade", ignore = true),[m
[32m+[m			[32m@Mapping(target = "statusLeilao", ignore = true),[m
[32m+[m			[32m@Mapping(target = "transportadorSelecionado", ignore = true),[m
[32m+[m			[32m@Mapping(target = "distanciaKm", ignore = true),[m
[32m+[m			[32m@Mapping(target = "anttPisoMinimo", ignore = true),[m
[32m+[m			[32m@Mapping(target = "precoSugerido", ignore = true),[m
[32m+[m			[32m@Mapping(target = "custoBaseMercado", ignore = true),[m
[32m+[m			[32m@Mapping(target = "valorFinalAceito", ignore = true),[m
[32m+[m			[32m@Mapping(source = "tipoEmbalagem", target = "tipoEmbalagem"),[m
[32m+[m			[32m@Mapping(source = "valorInicialProposto", target = "valorInicialProposto")[m
[32m+[m	[32m})[m
[32m+[m	[32mvoid updateEntity(FreteRequest request, @MappingTarget Frete entity);[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/service/mapper/ItemFreteMapper.java b/src/main/java/br/com/wta/frete/logistica/service/mapper/ItemFreteMapper.java[m
[1mindex b3c5a2c..53624e4 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/service/mapper/ItemFreteMapper.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/service/mapper/ItemFreteMapper.java[m
[36m@@ -2,63 +2,47 @@[m [mpackage br.com.wta.frete.logistica.service.mapper;[m
 [m
 import org.mapstruct.Mapper;[m
 import org.mapstruct.Mapping;[m
[31m-import org.mapstruct.ReportingPolicy;[m
[31m-import org.mapstruct.factory.Mappers;[m
[32m+[m[32mimport org.mapstruct.MappingTarget;[m
[32m+[m[32mimport org.mapstruct.Mappings;[m
 [m
 import br.com.wta.frete.logistica.controller.dto.ItemFreteRequest;[m
 import br.com.wta.frete.logistica.controller.dto.ItemFreteResponse;[m
[31m-import br.com.wta.frete.logistica.entity.Frete;[m
 import br.com.wta.frete.logistica.entity.ItemFrete;[m
 [m
 /**[m
[31m- * Mapper para a entidade ItemFrete, respons√°vel por converter entre[m
[31m- * ItemFreteRequest/Response e ItemFrete (Entidade).[m
[32m+[m[32m * Mapeador MapStruct para convers√£o entre DTOs e a entidade ItemFrete.[m
[32m+[m[32m *[m
[32m+[m[32m * CORRE√á√ÉO: Alinhamento da Foreign Key (FK) para frete.freteId.[m
  */[m
[31m-@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)[m
[32m+[m[32m@Mapper(componentModel = "spring")[m
 public interface ItemFreteMapper {[m
 [m
[31m-	ItemFreteMapper INSTANCE = Mappers.getMapper(ItemFreteMapper.class);[m
[31m-[m
 	/**[m
[31m-	 * Converte um ItemFreteRequest para a entidade ItemFrete. Mapeia[m
[31m-	 * 'ordemServicoId' do Request para a entidade 'frete' em ItemFrete.[m
[31m-	 * [m
[31m-	 * @param request DTO de requisi√ß√£o (entrada de dados).[m
[31m-	 * @return A entidade ItemFrete.[m
[32m+[m	[32m * Converte um DTO de requisi√ß√£o para a entidade ItemFrete.[m
 	 */[m
[31m-	@Mapping(target = "id", ignore = true)[m
[31m-	@Mapping(target = "frete", source = "ordemServicoId")[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(target = "id", ignore = true),[m
[32m+[m			[32m@Mapping(target = "frete", ignore = true)[m
[32m+[m	[32m})[m
 	ItemFrete toEntity(ItemFreteRequest request);[m
 [m
 	/**[m
[31m-	 * Converte a entidade ItemFrete para o DTO de Resposta ItemFreteResponse.[m
[31m-	 * Mapeia 'frete.ordemServicoId' (PK do Frete) para 'ordemServicoId' do[m
[31m-	 * Response.[m
[31m-	 * [m
[31m-	 * @param entity Entidade ItemFrete.[m
[31m-	 * @return O DTO de resposta.[m
[32m+[m	[32m * Converte a entidade ItemFrete para o DTO de resposta.[m
[32m+[m	[32m * O campo freteId √© mapeado usando a PK real da entidade Frete.[m
 	 */[m
[31m-	@Mapping(target = "itemFreteId", source = "id")[m
[31m-	@Mapping(target = "ordemServicoId", source = "frete.ordemServicoId") // Corrigido para frete.ordemServicoId[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(source = "id", target = "itemFreteId"), // Mapeia a PK da entidade ItemFrete[m
[32m+[m			[32m// CORRE√á√ÉO FINAL: Usando frete.freteId, conforme a entidade Frete.java[m
[32m+[m			[32m@Mapping(source = "frete.freteId", target = "freteId")[m
[32m+[m	[32m})[m
 	ItemFreteResponse toResponse(ItemFrete entity);[m
 [m
 	/**[m
[31m-	 * M√©todo auxiliar para o MapStruct criar a entidade Frete a partir do ID. Agora[m
[31m-	 * usa o setter correto: setOrdemServicoId().[m
[31m-	 * [m
[31m-	 * @param ordemServicoId O ID da Ordem de Servi√ßo (Frete).[m
[31m-	 * @return Uma nova entidade Frete com apenas o ID preenchido.[m
[32m+[m	[32m * Atualiza uma entidade ItemFrete existente com base nos dados do DTO.[m
 	 */[m
[31m-	default Frete toFrete(Long ordemServicoId) {[m
[31m-		if (ordemServicoId == null) {[m
[31m-			return null;[m
[31m-		}[m
[31m-[m
[31m-		// CORRE√á√ÉO: Usando o setter correto gerado pelo Lombok para a PK da Entidade[m
[31m-		// Frete.[m
[31m-		Frete frete = new Frete();[m
[31m-		frete.setOrdemServicoId(ordemServicoId);[m
[31m-[m
[31m-		return frete;[m
[31m-	}[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(target = "id", ignore = true),[m
[32m+[m			[32m@Mapping(target = "frete", ignore = true)[m
[32m+[m	[32m})[m
[32m+[m	[32mvoid updateEntity(ItemFreteRequest request, @MappingTarget ItemFrete entity);[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/java/br/com/wta/frete/logistica/service/mapper/LanceMapper.java b/src/main/java/br/com/wta/frete/logistica/service/mapper/LanceMapper.java[m
[1mindex 2595054..fe5516e 100644[m
[1m--- a/src/main/java/br/com/wta/frete/logistica/service/mapper/LanceMapper.java[m
[1m+++ b/src/main/java/br/com/wta/frete/logistica/service/mapper/LanceMapper.java[m
[36m@@ -2,91 +2,51 @@[m [mpackage br.com.wta.frete.logistica.service.mapper;[m
 [m
 import org.mapstruct.Mapper;[m
 import org.mapstruct.Mapping;[m
[31m-import org.mapstruct.ReportingPolicy;[m
[31m-import org.mapstruct.factory.Mappers;[m
[32m+[m[32mimport org.mapstruct.Mappings;[m
 [m
[31m-import br.com.wta.frete.colaboradores.entity.Transportador;[m
 import br.com.wta.frete.logistica.controller.dto.LanceRequest;[m
 import br.com.wta.frete.logistica.controller.dto.LanceResponse;[m
[31m-import br.com.wta.frete.logistica.entity.Frete;[m
 import br.com.wta.frete.logistica.entity.Lance;[m
 [m
 /**[m
[31m- * Mapper para a entidade Lance, respons√°vel por converter entre[m
[31m- * LanceRequest/Response e Lance (Entidade). Utiliza o MapStruct para[m
[31m- * simplificar as convers√µes de DTO para Entity.[m
[32m+[m[32m * Mapeador MapStruct para convers√£o entre DTOs e a entidade Lance.[m
  */[m
[31m-@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)[m
[32m+[m[32m@Mapper(componentModel = "spring")[m
 public interface LanceMapper {[m
 [m
[31m-	// Opcional: Para uso fora do contexto Spring (embora componentModel="spring"[m
[31m-	// seja recomendado)[m
[31m-	LanceMapper INSTANCE = Mappers.getMapper(LanceMapper.class);[m
[31m-[m
[31m-	// --- Mapeamento de Request para Entidade (Cria√ß√£o de Lance) ---[m
[31m-[m
 	/**[m
[31m-	 * Converte um LanceRequest para a entidade Lance. - Mapeia os IDs de FKs para[m
[31m-	 * as entidades correspondentes (Frete e Transportador) utilizando os m√©todos[m
[31m-	 * default toFrete e toTransportador. - Ignora 'id' pois √© gerado pelo BD.[m
[32m+[m	[32m * Converte o DTO de Requisi√ß√£o para a Entidade Lance.[m
 	 */[m
[31m-	@Mapping(target = "id", ignore = true)[m
[31m-	@Mapping(target = "frete", source = "ordemServicoId")[m
[31m-	@Mapping(target = "transportador", source = "transportadorPessoaId")[m
[31m-	@Mapping(target = "dataLance", ignore = true) // Deixa a entidade setar o default: ZonedDateTime.now()[m
[31m-	@Mapping(target = "vencedor", ignore = true) // Deixa a entidade setar o default: false[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(target = "id", ignore = true),[m
[32m+[m			[32m@Mapping(target = "frete", ignore = true),[m
[32m+[m			[32m@Mapping(target = "transportador", ignore = true),[m
[32m+[m			[32m// O MapStruct pode precisar de ajuda extra quando o nome do DTO n√£o coincide[m
[32m+[m			[32m// exatamente com o nome da Entidade (valorProposto/valorLance), mas a[m
[32m+[m			[32m// corre√ß√£o anterior j√° alinhou para 'valorLance', ent√£o o mapeamento √©[m
[32m+[m			[32m// impl√≠cito ou por getter. Vamos manter limpo.[m
[32m+[m			[32m@Mapping(target = "dataLance", ignore = true), // Ser√° setado no Service (agora)[m
[32m+[m			[32m@Mapping(target = "vencedor", ignore = true), // Ser√° setado no Service[m
[32m+[m			[32m@Mapping(target = "motivoCancelamento", ignore = true) // Ser√° setado no Service ou no futuro[m
[32m+[m	[32m})[m
 	Lance toEntity(LanceRequest request);[m
 [m
[31m-	// --- Mapeamento de Entidade para Response (Leitura de Lance) ---[m
[31m-[m
 	/**[m
[31m-	 * Converte a entidade Lance para o DTO de Resposta LanceResponse. - Mapeia o PK[m
[31m-	 * da entidade Lance (id) para lanceId (do DTO). - Mapeia a PK da entidade Frete[m
[31m-	 * (frete.ordemServicoId) para ordemServicoId (do DTO). - Mapeia a PK da[m
[31m-	 * entidade Transportador (transportador.pessoaId) para transportadorPessoaId[m
[31m-	 * (do DTO).[m
[32m+[m	[32m * Converte a Entidade Lance para o DTO de Resposta.[m
 	 */[m
[31m-	@Mapping(target = "lanceId", source = "id")[m
[31m-	@Mapping(target = "ordemServicoId", source = "frete.ordemServicoId")[m
[31m-	@Mapping(target = "transportadorPessoaId", source = "transportador.pessoaId") // CORRE√á√ÉO: Mapeado para o PK[m
[31m-																					// 'pessoaId'[m
[32m+[m	[32m@Mappings({[m
[32m+[m			[32m@Mapping(source = "id", target = "lanceId"),[m
[32m+[m			[32m@Mapping(source = "frete.freteId", target = "freteId"),[m
[32m+[m			[32m@Mapping(source = "transportador.pessoaId", target = "transportadorId"),[m
[32m+[m
[32m+[m			[32m// CORRE√á√ÉO: Mapeamentos expl√≠citos para resolver o erro "Unmapped target[m
[32m+[m			[32m// properties"[m
[32m+[m			[32m@Mapping(source = "dataLance", target = "dataLance"),[m
[32m+[m			[32m@Mapping(source = "vencedor", target = "vencedor"),[m
[32m+[m			[32m@Mapping(source = "motivoCancelamento", target = "motivoCancelamento"),[m
[32m+[m
[32m+[m			[32m// L√≥gica para buscar o nome do Transportador: transportador -> pessoa -> nome[m
[32m+[m			[32m@Mapping(target = "nomeTransportador", expression = "java(entity.getTransportador() != null && entity.getTransportador().getPessoa() != null ? entity.getTransportador().getPessoa().getNome() : \"Desconhecido\")")[m
[32m+[m	[32m})[m
 	LanceResponse toResponse(Lance entity);[m
[31m-[m
[31m-	// --- M√©todos Auxiliares para Inje√ß√£o de Entidades por ID ---[m
[31m-[m
[31m-	/**[m
[31m-	 * M√©todo auxiliar para o MapStruct criar a entidade Frete a partir do ID[m
[31m-	 * (ordemServicoId). Essencial para criar a refer√™ncia de FK sem buscar no banco[m
[31m-	 * de dados.[m
[31m-	 * [m
[31m-	 * @param ordemServicoId O ID da Ordem de Servi√ßo (Frete).[m
[31m-	 * @return Uma nova entidade Frete com apenas o ID preenchido.[m
[31m-	 */[m
[31m-	default Frete toFrete(Long ordemServicoId) {[m
[31m-		if (ordemServicoId == null) {[m
[31m-			return null;[m
[31m-		}[m
[31m-		Frete frete = new Frete();[m
[31m-		// A chave prim√°ria √© 'ordemServicoId'[m
[31m-		frete.setOrdemServicoId(ordemServicoId);[m
[31m-		return frete;[m
[31m-	}[m
[31m-[m
[31m-	/**[m
[31m-	 * M√©todo auxiliar para o MapStruct criar a entidade Transportador a partir do[m
[31m-	 * ID (transportadorPessoaId). Essencial para criar a refer√™ncia de FK sem[m
[31m-	 * buscar no banco de dados.[m
[31m-	 * [m
[31m-	 * @param transportadorPessoaId O ID do Transportador.[m
[31m-	 * @return Uma nova entidade Transportador com apenas o ID preenchido.[m
[31m-	 */[m
[31m-	default Transportador toTransportador(Long transportadorPessoaId) {[m
[31m-		if (transportadorPessoaId == null) {[m
[31m-			return null;[m
[31m-		}[m
[31m-		Transportador transportador = new Transportador();[m
[31m-		// CORRE√á√ÉO: A chave prim√°ria √© 'pessoaId' e o setter √© 'setPessoaId'[m
[31m-		transportador.setPessoaId(transportadorPessoaId);[m
[31m-		return transportador;[m
[31m-	}[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/main/resources/db/migration/V1__Initial_Schema.sql b/src/main/resources/db/migration/V1__Initial_Schema.sql[m
[1mindex 20c9e6d..4c23a6f 100644[m
[1m--- a/src/main/resources/db/migration/V1__Initial_Schema.sql[m
[1m+++ b/src/main/resources/db/migration/V1__Initial_Schema.sql[m
[36m@@ -430,12 +430,16 @@[m [mCREATE TABLE logistica.fretes ([m
     ordem_servico_id BIGINT NOT NULL,[m
     modalidade_id INTEGER NOT NULL,[m
     status_leilao_id INTEGER NOT NULL,[m
[32m+[m[32m    transportador_selecionado_id BIGINT,[m
     data_expiracao_negociacao TIMESTAMP WITH TIME ZONE,[m
[31m-    preco_sugerido NUMERIC(10, 2),[m
[32m+[m[32m    distancia_km NUMERIC(10, 2),[m
     antt_piso_minimo NUMERIC(10, 2),[m
[32m+[m[32m    preco_sugerido NUMERIC(10, 2),[m
     custo_base_mercado NUMERIC(10, 2),[m
[31m-    distancia_km NUMERIC(10, 2),[m
[31m-    transportador_selecionado_id BIGINT[m
[32m+[m[32m    peso_total_kg NUMERIC(19, 2),[m
[32m+[m[32m    valor_inicial_proposto NUMERIC(10, 2),[m
[32m+[m[32m    valor_final_aceito NUMERIC(10, 2),[m
[32m+[m[32m    tipo_embalagem VARCHAR(50)[m
     -- Todas as FKs removidas[m
 );[m
 [m
